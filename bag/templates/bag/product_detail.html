{% extends 'bag/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'bag/css/product_detail.css' %}">
{% endblock %}

{% block content %}

<div class="page-wrapper">

    <div class="product-container">

        <!-- üîπ IMAGE SECTION -->
        <div class="product-image">

            <button class="favorite"
                    aria-label="wishlist"
                    data-product-id="{{ product.id }}">

                {% if user.is_authenticated and product in user.favorites.all %}
                    ‚ù§Ô∏è
                {% else %}
                    ü§ç
                {% endif %}

            </button>

            <img src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy">

        </div>

        <!-- üîπ PRODUCT INFO -->
        <div class="product-info">

            <h2 class="product-title">{{ product.name }}</h2>

            <p class="product-desc">
                {{ product.description|default:"Fresh & organic product." }}
            </p>

            <div class="price">‚Çπ{{ product.price }}</div>

            <!-- üîπ QUANTITY -->
            <div class="qty-box">

                <button type="button" id="decBtn">‚àí</button>

                <span id="qty">1</span>

                <button type="button" id="incBtn">+</button>

            </div>

            <!-- üîπ ADD TO CART -->
            <a id="cartBtn"
               href="{% url 'add_to_cart' product.id %}?qty=1"
               class="cart-btn">

               üõí Add to Cart

            </a>

        </div>

    </div>

</div>

<!-- ‚úÖ JAVASCRIPT -->
<script>

document.addEventListener("DOMContentLoaded", function () {

    let qty = 1;

    const qtyDisplay = document.getElementById("qty");
    const cartBtn = document.getElementById("cartBtn");

    const incBtn = document.getElementById("incBtn");
    const decBtn = document.getElementById("decBtn");

    const baseCartUrl = "{% url 'add_to_cart' product.id %}?qty=";

    /* üîπ INCREASE QTY */
    incBtn.addEventListener("click", function () {
        qty++;
        updateQty();
    });

    /* üîπ DECREASE QTY */
    decBtn.addEventListener("click", function () {
        if (qty > 1) {
            qty--;
            updateQty();
        }
    });

    function updateQty() {
        qtyDisplay.innerText = qty;
        cartBtn.href = baseCartUrl + qty;
    }

    /* üîπ ‚ù§Ô∏è WISHLIST TOGGLE */
    const fav = document.querySelector(".favorite");

    if (fav) {

        fav.addEventListener("click", function () {

            const productId = this.dataset.productId;

            fetch("{% url 'toggle_favorite' 0 %}".replace("0", productId), {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Accept": "application/json",
                    "Content-Type": "application/json"
                }
            })
            .then(res => res.json())
            .then(data => {
                this.textContent = data.status === "added" ? "‚ù§Ô∏è" : "ü§ç";
            });

        });

    }

});

</script>

{% endblock %}
